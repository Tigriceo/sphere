import*as e from"three";import t from"/js/three/tween.module.js";import{OrbitControls as a}from"/js/three/OrbitControls.js";import{FontLoader as i}from"/js/three/FontLoader.js";import s from"/js/three/stats.module.js";class LS_Core{constructor(){this.table=[],this.camera,this.scene,this.renderer,this.controls,this.raycaster=new e.Raycaster,this.mouse=new e.Vector2,this.lastCameraPosition=new e.Vector3,this.hoveredObject=null,this.container=document.getElementById("container"),this.sphereTransformed=!1,this.objects=[],this.objectSize={imgWidth:200,imgHeight:200,shadowGeometryWidth:210,shadowGeometryHeight:260,frameGeometryWidth:210,frameGeometryHeight:260},this.objectsToLoad=[],this.targets={sphere:[]},this.fontUrl="/js/three/font/uni_sans_bold_regular.json",this.arrangeTime=2e3,this.boxInfo={hoverBoxBackColor:"rgb(21,68,138)",hoverBoxActive:.2,hoverBoxInActive:0,textColor:"rgb(21,68,138)"},this.stats=s(),this.init()}init(){e&&t&&this.container&&(this.addPhotos(),this.initThreeRender(),this.animate(),this.showFPS(),console.log(this))}showFPS(){document.body.appendChild(this.stats.dom)}addPhotos(){for(let e=1;e<=67;e++)this.table.push({img:`images/test/avif/image-${e}.avif`,name:`Test ${e}`})}initThreeRender(){this.camera=new e.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,1e4),this.camera.position.z=3e3,this.scene=new e.Scene,this.renderer=new e.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=e.PCFSoftShadowMap,this.container.appendChild(this.renderer.domElement),this.light=new e.DirectionalLight(16777215,1),this.light.position.set(0,500,500),this.light.castShadow=!0,this.light.lookAt(new e.Vector3(0,0,0)),this.scene.add(this.light),this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.light.shadow.camera.near=.5,this.light.shadow.camera.far=5e3,this.light.shadow.camera.left=-500,this.light.shadow.camera.right=500,this.light.shadow.camera.top=500,this.light.shadow.camera.bottom=-500;let t=new e.AmbientLight(16777215,.5);this.scene.add(t);let s=new i;s.load(this.fontUrl,e=>{this.createObjects(e)}),this.controls=new a(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.02,this.controls.minDistance=1300,this.controls.maxDistance=3800,window.addEventListener("resize",()=>this.onWindowResize()),window.addEventListener("mousemove",e=>this.onMouseMove(e))}createObjects(t){let a=new e.TextureLoader;a.anisotropy=this.renderer.capabilities.getMaxAnisotropy();for(let i=0;i<this.table.length;i++){let s=new e.MeshBasicMaterial({side:e.DoubleSide,transparent:!0,opacity:0}),o=new e.PlaneGeometry(this.objectSize.imgWidth,this.objectSize.imgHeight),r=new e.Mesh(o,s);r.castShadow=!0,r.frustumCulled=!0,r.visible=!1,r.userData.imagePath=this.table[i].img,r.userData.imageLoaded=!1,r.userData.imageLoading=!1,r.userData.opacityTween=null;let h=new e.MeshBasicMaterial({color:this.boxInfo.hoverBoxBackColor,transparent:!0,opacity:this.boxInfo.hoverBoxActive}),n=new e.PlaneGeometry(this.objectSize.shadowGeometryWidth,this.objectSize.shadowGeometryHeight),c=new e.Mesh(n,h);c.position.set(0,0,-5),c.receiveShadow=!0,c.userData={opacityTween:null};let l=this.createCaptionTexture(this.table[i].name);l.position.set(0,-100,0),l.material.opacity=0,l.userData={opacityTween:null};let d=new e.EdgesGeometry(new e.PlaneGeometry(this.objectSize.frameGeometryWidth,this.objectSize.frameGeometryHeight)),m=new e.ShaderMaterial({uniforms:{glowColor:{value:new e.Color(65535)},intensity:{value:2.5}},vertexShader:`
                    varying vec3 vNormal;
                    void main() {
                        vNormal = normalize(normalMatrix * normal);
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,fragmentShader:`
                    uniform vec3 glowColor;
                    uniform float intensity;
                    varying vec3 vNormal;
                    void main() {
                        float alpha = pow(1.0 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 3.0);
                        gl_FragColor = vec4(glowColor * intensity, alpha);
                    }
                `}),$=new e.LineSegments(d,m);$.position.set(0,0,1),$.visible=!1;let g=new e.Group;g.add($),g.add(c),g.add(r),g.add(l),g.position.set(4e3*Math.random()-2e3,4e3*Math.random()-2e3,4e3*Math.random()-2e3),g.userData={textMesh:l,imgMesh:r,shadowMaterial:h,frameMesh:$},this.scene.add(g),this.objects.push(g),this.objectsToLoad.push(g)}this.arrangeSphere()}loadImageIfVisible(t,a=3e3){let i=t.userData.imgMesh;if(i.userData.imageLoaded||i.userData.imageLoading)return;let s=i.position.distanceTo(this.camera.position);if(s<=a){console.log("Загружаем изображение:",i.userData.imagePath),i.userData.imageLoading=!0;let o=new e.TextureLoader;o.load(i.userData.imagePath,e=>{i.material.map=e,i.userData.imageLoaded=!0,i.userData.imageLoading=!1,this.objectsToLoad=this.objectsToLoad.filter(e=>e!==t)})}}updateObjectsVisibility(){let a=this.camera.position.clone(),i=new e.Vector3(0,0,0);!(0!==this.lastCameraPosition.x&&2>this.lastCameraPosition.distanceTo(a))&&(this.lastCameraPosition.copy(a),this.objects.forEach(s=>{let o=s.userData.imgMesh;if(!o)return;let r=s.position.clone(),h=r.distanceTo(a),n=r.clone().sub(i).normalize(),c=a.clone().sub(i).normalize(),l=n.dot(c),d=0,m=!1,$=this.sphereTransformed?0:this.arrangeTime+1e3,g=e.MathUtils.clamp((4e3-h)/2e3,0,1);l>.66?(d=e.MathUtils.lerp(.5,1,g),m=!0):l>.33?(d=e.MathUtils.lerp(0,.5,g),m=!0):l>0?(d=0,m=!0):(d=0,m=!1),s.visible=m,o.material.opacity!==d&&(o.userData.imageLoaded||o.userData.imageLoading)&&(o.userData.opacityTween=new t.Tween(o.material).to({opacity:d},500).easing(t.Easing.Quadratic.Out).start()),!m||o.userData.imageLoaded||o.userData.imageLoading||(this.loadImageIfVisible(s),setTimeout(()=>{this.showSingleImage(s)},$))}),this.sphereTransformed&&this.objectsToLoad.length>0&&this.objectsToLoad.forEach(e=>{e.userData.shadowMaterial.opacity>0&&this.animateShadowOpacity(e.userData.shadowMaterial,0)}))}createCaptionTexture(t){let a=document.createElement("canvas"),i=a.getContext("2d");a.width=256,a.height=64,i.fillStyle=this.boxInfo.textColor,i.font="Bold 32px UniSansBold",i.textAlign="center",i.fillText(t,a.width/2,a.height/2);let s=new e.CanvasTexture(a),o=new e.MeshBasicMaterial({map:s,transparent:!0,opacity:0}),r=new e.PlaneGeometry(180,50);return new e.Mesh(r,o)}showSingleImage(e,a=1){if(e.userData&&e.userData.imgMesh.material)e.userData.imgMesh.visible=!0,e.userData.imgMesh.userData.opacityTween&&e.userData.imgMesh.userData.opacityTween.stop(),e.userData.imgMesh.userData.opacityTween=new t.Tween(e.userData.imgMesh.material).to({opacity:1},1e3).delay(50*a).easing(t.Easing.Quadratic.Out).start(),e.userData.shadowMaterial&&setTimeout(()=>{this.animateShadowOpacity(e.userData.shadowMaterial,this.boxInfo.hoverBoxInActive)},60*a)}animateTextOpacity(e,a){e&&e.material&&(e.userData.opacityTween&&e.userData.opacityTween.stop(),e.userData.opacityTween=new t.Tween(e.material).to({opacity:a},500).easing(t.Easing.Quadratic.Out).start())}animateShadowOpacity(e,a){e&&(e.userData.opacityTween&&e.userData.opacityTween.stop(),e.userData.opacityTween=new t.Tween(e).to({opacity:a},500).easing(t.Easing.Quadratic.Out).start())}checkIntersections(){this.raycaster.setFromCamera(this.mouse,this.camera);let e=this.raycaster.intersectObjects(this.objects,!0);if(e.length>0){let t=e[0].object.parent;if(!t||!t.userData||t.userData.isHovered||this.hoveredObject===t)return;this.hoveredObject&&this.hoveredObject!==t&&(this.hoveredObject.userData.isHovered=!1,this.animateTextOpacity(this.hoveredObject.userData.textMesh,0),this.animateShadowOpacity(this.hoveredObject.userData.shadowMaterial,this.boxInfo.hoverBoxInActive),this.hoveredObject.userData.frameMesh&&(this.hoveredObject.userData.frameMesh.visible=!1)),this.hoveredObject=t,this.hoveredObject.userData.isHovered=!0,this.animateTextOpacity(this.hoveredObject.userData.textMesh,1),this.animateShadowOpacity(this.hoveredObject.userData.shadowMaterial,this.boxInfo.hoverBoxActive),this.hoveredObject.userData.frameMesh&&(this.hoveredObject.userData.frameMesh.visible=!0)}else this.hoveredObject&&(this.hoveredObject.userData.isHovered=!1,this.animateTextOpacity(this.hoveredObject.userData.textMesh,0),this.animateShadowOpacity(this.hoveredObject.userData.shadowMaterial,this.boxInfo.hoverBoxInActive),this.hoveredObject.userData.frameMesh&&(this.hoveredObject.userData.frameMesh.visible=!1),this.hoveredObject=null)}arrangeSphere(){let t=(1+Math.sqrt(5))/2;for(let a=0;a<this.objects.length;a++){let i=1-a/(this.objects.length-1)*2,s=Math.sqrt(1-i*i),o=2*Math.PI*a/t,r=new e.Object3D;r.position.set(800*s*Math.cos(o),800*i,800*s*Math.sin(o)),r.lookAt(new e.Vector3),this.targets.sphere.push(r)}this.transform(this.targets.sphere,this.arrangeTime)}fibonacciSphere(t,a){let i=[],s=Math.PI*(3-Math.sqrt(5));for(let o=0;o<t;o++){let r=1-o/(t-1)*2,h=Math.sqrt(1-r*r)*a,n=s*o,c=Math.cos(n)*h,l=Math.sin(n)*h;i.push(new e.Vector3(c,r*a,l))}return i}transform(e,a){t.removeAll();for(let i=0;i<this.objects.length;i++)new t.Tween(this.objects[i].position).to(e[i].position,Math.random()*a+a).easing(t.Easing.Exponential.InOut).onComplete(()=>{this.sphereTransformed=!0}).start()}onMouseMove(e){this.mouse.x=e.clientX/window.innerWidth*2-1,this.mouse.y=-(2*(e.clientY/window.innerHeight))+1}handleClick(){this.raycaster.setFromCamera(this.mouse,this.camera);let e=this.raycaster.intersectObjects(this.objects,!0);if(e.length>0){let a=e[0].object.parent;if(!a)return;let i=this.camera.position.length(),s=a.position.clone().normalize(),o=s.multiplyScalar(i);new t.Tween(this.camera.position).to({x:o.x,y:o.y,z:o.z},1e3).easing(t.Easing.Quadratic.Out).start(),new t.Tween(this.controls.target).to({x:a.position.x,y:a.position.y,z:a.position.z},1e3).easing(t.Easing.Quadratic.Out).start()}}checkVisibleObjects(){this.objectsToLoad&&!(this.objectsToLoad.length<1)&&this.objectsToLoad.forEach(e=>{this.loadImageIfVisible(e)})}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate()),this.checkIntersections(),t.update(),this.updateObjectsVisibility(),this.controls.update(),this.objects.forEach(e=>{e.quaternion.copy(this.camera.quaternion)}),this.renderer.render(this.scene,this.camera),this.stats.update()}render(){this.renderer.render(this.scene,this.camera)}}new LS_Core;